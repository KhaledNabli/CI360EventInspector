<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CI360 Event Inspector</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.lumen.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
  </head>

  <body>
    
    <div class="container">
        <div class="row">
            <h3>Customer Profile</h3>
            <div class="col-lg-6">
                <div class="col-lg-4">
                    <img data-src="holder.js/150x180?theme=sky&amp;text=Unknown Visitor" class="img-responsive" alt="No Image. [150x200]">
                </div>
                <div class="col-lg-4">
                    <h4>Unknown Visitor</h4>
                    <p>
                        Email: ...<br/>
                        Age: ...<br/>
                        Segment: ...<br/>
                        Interests: ...<br/>
                        Location: ...<br/>
                        Social Media: ...<br/>
                    </p>
                </div>

            </div>
            <div class="col-lg-6">
                Last Update: <span id="infoLastUpdate">...</span><br/>
                Current Page: <span id="infoCurrentPage">...</span><br/>
                Platform: <span id="infoPlatform">...</span><br/>
                Language: <span id="infoLanguage">...</span><br/>
                Screen: <span id="infoScreen">...</span><br/>
                Browser Size: <span id="infoBsz">...</span><br/>
                Security: <span id="infoSecurity">...</span><br/>
                Visitor: <span id="infoVisitor">...</span><br/>
                Session: <span id="infoSession">...</span><br/>
            </div>
            
        </div>

    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <hr />
                <h3>Event History</h3>
            </div>

            <div id="journeyFlow" class="col-lg-12">
                
            </div>
            <div class="col-lg-12">
                <hr />
            </div>

        </div>
    </div>


    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <h3>Event Details</h3> <a onclick="toggleFullDetails();">(display/hide all)</a>
            </div>
            <div id="eventDetails" class="col-lg-12">
                Event Details (open)
            </div>
        </div>

    </div>




    <script src="js/ext/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="js/ext/jquery-ui.js" type="text/javascript"></script>
    <script src="js/ext/bootstrap.min.js" type="text/javascript"></script>
    <script src="js/ext/holder.min.js" type="text/javascript"></script>
    <script src="js/inspector.js" type="text/javascript"></script>
    <script type="text/javascript">

    var eventHistory = [];
    var relevantEvents = {"load": ["event", "page_title", "referrer", "uri", "^pe_*"], "click": ["event", "title", "targetInnerText", "anchor_href"], "change": ["event", "form.f.\\w+"]};
    var displayFullDetails = false;

    function addEventToJourney(eventClass, eventTitle, eventText,eventId) {
        // if journey has 12 elements, than remove first and append last
        var htmlElement = "<div class=\"col-lg-1\"><div  data-toggle=\"tooltip\" data-placement=\"bottom\" class=\"event "+eventClass+"\" title=\""+eventTitle+"\" onclick=\"displayEventDetails("+eventId+")\">" + eventText + "</div></div>";
        $("#journeyFlow").append(htmlElement);
        if($("#journeyFlow > div").length > 12) {
           $("#journeyFlow > div:eq(0)").remove(); 
        }

        $(function () {
          $('[data-toggle="tooltip"]').tooltip()
        })

        displayEventDetails(eventId);
    }


    function trackEvent(eventData) {
        //alert(eventData.event);
        console.log(eventData);
        eventHistory.push(eventData);
        var eventId = eventHistory.length-1;
        parseEventData(eventData, eventId);

        // insert event into localStorage...
        localStorage.setItem('CI360InspectorEvents', JSON.stringify(eventHistory.slice(-60)));
        
    }

    function loadPreviousEvents(eventHistory) {
        eventHistory = JSON.parse(localStorage.getItem('CI360InspectorEvents') ? localStorage.getItem('CI360InspectorEvents') : "[]");

        for(eventId in eventHistory) {
            // display it...
            parseEventData(eventHistory[eventId], eventId);
        }
    }



    function parseEventData(eventData, eventId) {
        $("#infoLastUpdate").html(timeConverter(parseInt(eventData.timestamp)));

        if(eventData.event === "load") {

            $("#infoVisitor").html(decodeURIComponent(eventData["visitor"]));
            $("#infoSession").html(decodeURIComponent(eventData["session"]));
            $("#infoSecurity").html(decodeURIComponent(eventData["protocol"]));
            $("#infoScreen").html(decodeURIComponent(eventData["screen_info"]));
            $("#infoBsz").html(decodeURIComponent(eventData["bsz"]));
            $("#infoLanguage").html(decodeURIComponent(eventData["browser_language"]));
            $("#infoPlatform").html(decodeURIComponent(eventData["platform"]));
            $("#infoCurrentPage").html(decodeURIComponent(eventData["page_title"]));


            addEventToJourney("load", decodeURIComponent(eventData["page_title"]), "Page View" , eventId);

        }
        else if(eventData.event === "click") {
            addEventToJourney("click", "Click on " + decodeURIComponent(eventData["title"]), "Click", eventId);

        }
        else if(eventData.event === "change") {
            addEventToJourney("change", "Change on " + decodeURIComponent(eventData["form._h.id"]), "Change", eventId);
        }
        else if(eventData.event === "submit") {
            
        }
        else {
            //console.log("ignoring event " + eventData.event);
            //console.log(eventData);
        }
    }

    function displayEventDetails(eventId) {
        

        var resultHtml = "<table class=\"table table-striped\">";
        for(prop in eventHistory[eventId]) {


            var isImportant = false;
            if(relevantEvents.hasOwnProperty(eventHistory[eventId].event)) {
                for (selector of relevantEvents[eventHistory[eventId].event]) {
                    var regEx = new RegExp(selector, "g");
                    isImportant = regEx.test(prop);
                    if(isImportant) {
                        break;
                    }
                }
            }
            resultHtml += "<tr class=\"" + (isImportant ? "highlighted" : "details") + "\" ><td>" + prop + " </td>  <td>" + decodeURIComponent(eventHistory[eventId][prop]) + "</td> </tr>";
        }

        resultHtml +="</table>";


        $("#eventDetails").html(resultHtml);
        if(!displayFullDetails) {
            $("tr.details").hide();
        }
        

    }


    function toggleFullDetails() {
        if(displayFullDetails) {
            displayFullDetails = false;
            $("tr.details").hide();
        } else {
            displayFullDetails = true;
            $("tr.details").show();
        }
    }


    function timeConverter(UNIX_timestamp){
        return (new Date(UNIX_timestamp)).toGMTString()
    }

    $( document ).ready(function() {
        loadPreviousEvents();
        // read events from localStorage...
        eventHistory = JSON.parse(localStorage.getItem('CI360InspectorEvents') ? localStorage.getItem('CI360InspectorEvents') : "[]");

        window.addEventListener('message', function(event) {
            // The data sent with postMessage is stored in event.data
            console.log("Recieved Event from CI360");
            console.log(event.data);
            trackEvent(event.data);
        });
    });
    </script>
  </body>
</html>


